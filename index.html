<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººè®°è´¦åŠ©æ‰‹ (PCç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ SheetJS ç”¨äºè§£æ Excel æ–‡ä»¶ -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥ PDF.js ç”¨äºè§£æ PDF æ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // é…ç½® PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Drag active state */
        .drag-active {
            border-color: #3b82f6 !important; /* blue-500 */
            background-color: #eff6ff !important; /* blue-50 */
            transform: scale(1.01);
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex overflow-hidden text-gray-800">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col transition-all duration-300">
        <div class="p-6 flex items-center gap-3 border-b border-gray-100">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-blue-200 shadow-lg">
                <i data-lucide="wallet"></i>
            </div>
            <div>
                <h1 class="font-bold text-xl text-gray-800">æˆ‘çš„è´¦æœ¬</h1>
                <p class="text-xs text-gray-400">Personal Finance</p>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="router('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-colors text-blue-600 bg-blue-50">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                æ”¶æ”¯æ¦‚è§ˆ
            </button>
            <button onclick="router('analysis')" id="nav-analysis" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50 transition-colors">
                <i data-lucide="pie-chart" class="w-5 h-5"></i>
                ç»Ÿè®¡åˆ†æ
            </button>
            <button onclick="router('add')" id="nav-add" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50 transition-colors">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                è®°ä¸€ç¬”
            </button>
            <button onclick="router('import')" id="nav-import" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50 transition-colors">
                <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                å¯¼å…¥è´¦å•
            </button>
        </nav>

        <div class="p-4 border-t border-gray-100">
            <div class="bg-blue-50 rounded-xl p-4">
                <p class="text-xs text-blue-600 font-bold mb-1">æ•°æ®å­˜å‚¨è¯´æ˜</p>
                <p class="text-xs text-blue-400">æ•°æ®ä¿å­˜åœ¨æ‚¨çš„æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œè¯·å‹¿æ¸…é™¤ç¼“å­˜ä»¥å…æ•°æ®ä¸¢å¤±ã€‚</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <!-- Top Bar -->
        <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-8 flex-shrink-0">
            <div class="flex items-center gap-4">
                <h2 id="page-title" class="text-lg font-bold text-gray-800">æ”¶æ”¯æ¦‚è§ˆ</h2>
                <div id="analysis-filter" class="hidden">
                    <input type="month" id="analysis-month-picker" onchange="renderAnalysisCharts()" class="bg-gray-100 border-none text-sm rounded-lg px-3 py-1 outline-none focus:ring-2 focus:ring-blue-200 font-medium text-gray-600">
                </div>
            </div>
            <div class="text-sm text-gray-500" id="current-date"></div>
        </header>

        <!-- Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-8 fade-in">
            <!-- Dynamic Content injected by JS -->
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed top-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-[-150%] transition-transform duration-300 z-50 flex items-center gap-2">
        <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
        <span id="toast-msg">æ“ä½œæˆåŠŸ</span>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center fade-in">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md m-4 shadow-2xl transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-gray-800">é€‰æ‹©æ–°åˆ†ç±»</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="edit-category-grid" class="grid grid-cols-4 gap-3 mb-2">
                <!-- Categories will be injected here -->
            </div>
            
            <input type="hidden" id="edit-transaction-id">
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // --- Config ---
        const CATEGORIES = {
            expense: [
                { 
                    id: 'food', 
                    name: 'é¤é¥®ç¾é£Ÿ', 
                    icon: 'ğŸ”', 
                    keywords: [
                        'é¤é¥®', 'ç¾é£Ÿ', 'é¥¿äº†ä¹ˆ', 'ç¾å›¢', 'éº¦å½“åŠ³', 'è‚¯å¾·åŸº', 'æ˜Ÿå·´å…‹', 'ç‘å¹¸', 'å–œèŒ¶', 'å¥ˆé›ª', 
                        'é¥­', 'é¢', 'ç²‰', 'ç²¥', 'é¥¼', 'åŒ…å­', 'é²œåŒ…', 'æ±¤åŒ…', 'ç…åŒ…', 'é¦’å¤´', 'æ°´é¥º', 'é¦„é¥¨', 'çƒ§éº¦', 'è’¸é¥º',
                        'æ—©ç‚¹', 'æ—©é¤', 'å¤œå®µ', 'éº»è¾£çƒ«', 'ç«é”…', 'é¦™é”…', 'çƒ§çƒ¤', 'çƒ¤è‚‰', 
                        'æ–™ç†', 'é¤å…', 'é£Ÿå ‚', 'é…’æ¥¼', 'èŒ¶é¤å…', 'ç§æˆ¿èœ', 'å°åƒ', 'é›¶é£Ÿ', 'ç‚¸é¸¡', 'æ±‰å ¡', 'æŠ«è¨', 
                        'å¥¶èŒ¶', 'å’–å•¡', 'é¥®æ–™', 'é…’æ°´', 'æ°´æœ', 'ç”Ÿé²œ', 'èœå¸‚åœº', 'è¶…å¸‚', 'ä¾¿åˆ©åº—', '7-11', 'å…¨å®¶', 'ç½—æ£®', 'çº¢æ——', 'ç¾å®œä½³'
                    ] 
                },
                { 
                    id: 'transport', 
                    name: 'äº¤é€šå‡ºè¡Œ', 
                    icon: 'ğŸš—', 
                    keywords: [
                        'äº¤é€š', 'å‡ºè¡Œ', 'æ»´æ»´', 'æ‰“è½¦', 'å‡ºç§Ÿ', 'æ›¹æ“', 'T3', 'å“ˆå•°', 'é’æ¡”', 'ç¾å›¢å•è½¦', 'ä»£é©¾',
                        'è½¦è´¹', 'è·¯è´¹', 'é€šè¡Œè´¹', 'éš§é“', 'è·¯æ¡¥', 'ETC', 'åœè½¦', 'å……ç”µ',
                        'åœ°é“', 'å…¬äº¤', 'å·´å£«', 'å®¢è¿', 'è½®æ¸¡', 'é“è·¯', 'ç«è½¦', '12306', 'èˆªç©º', 'æœºç¥¨', 'é£çŒª', 'æºç¨‹', 'å»å“ªå„¿',
                        'åŠ æ²¹', 'çŸ³åŒ–', 'çŸ³æ²¹', 'æµ·æ²¹', 'ç§Ÿè½¦'
                    ] 
                },
                { 
                    id: 'shopping', 
                    name: 'è´­ç‰©æ¶ˆè´¹', 
                    icon: 'ğŸ›ï¸', 
                    keywords: [
                        'è´­ç‰©', 'æ·˜å®', 'äº¬ä¸œ', 'æ‹¼å¤šå¤š', 'å”¯å“ä¼š', 'æŠ–éŸ³', 'å¿«æ‰‹', 'å¾—ç‰©', 'è‹å®',
                        'ç™¾è´§', 'å•†åŸ', 'å¹¿åœº', 'å¥¥ç‰¹è±æ–¯', 'ä¼˜è¡£åº“', 'Zara', 'H&M', 'è¿ªå¡ä¾¬', 'ååˆ›ä¼˜å“', 
                        'å±ˆè‡£æ°', 'ä¸èŠ™å…°', 'ç¾å¦†', 'æœé¥°', 'é‹', 'åŒ…'
                    ] 
                },
                { id: 'entertainment', name: 'ä¼‘é—²å¨±ä¹', icon: 'ğŸ¬', keywords: ['å¨±ä¹', 'ç”µå½±', 'å½±åŸ', 'ç¥¨åŠ¡', 'æ¸¸æˆ', 'ç½‘æ˜“', 'è…¾è®¯', 'Steam', 'è§†é¢‘', 'ä¼šå‘˜', 'KTV', 'ç½‘å§', 'è¶³æµ´', 'æŒ‰æ‘©', 'æ´—æµ´', 'è¿ªå£«å°¼', 'ç¯çƒå½±åŸ'] },
                { id: 'housing', name: 'å±…ä½ç‰©ä¸š', icon: 'ğŸ ', keywords: ['æˆ¿ç§Ÿ', 'ç‰©ä¸š', 'ç”µè´¹', 'æ°´è´¹', 'ç‡ƒæ°”', 'å®½å¸¦', 'ç”µä¿¡', 'è”é€š', 'ç§»åŠ¨', 'æˆ¿è´·', 'å®¶æ”¿', 'ç»´ä¿®'] },
                { id: 'medical', name: 'åŒ»ç–—å¥åº·', icon: 'ğŸ’Š', keywords: ['åŒ»ç–—', 'åŒ»é™¢', 'è¯æˆ¿', 'è¯åº—', 'å¤§è¯æˆ¿', 'æŒ‚å·', 'é—¨è¯Š', 'ä½“æ£€', 'ç‰™ç§‘'] },
                { id: 'other', name: 'å…¶ä»–æ”¯å‡º', icon: 'ğŸ’¸', keywords: [] }
            ],
            income: [
                { id: 'salary', name: 'å·¥èµ„è–ªæ°´', icon: 'ğŸ’°', keywords: ['å·¥èµ„', 'è–ªèµ„', 'ä»£å‘', 'è¡¥åŠ©'] },
                { id: 'bonus', name: 'å¥–é‡‘è¡¥è´´', icon: 'ğŸ§§', keywords: ['å¥–é‡‘', 'çº¢åŒ…', 'è½¬è´¦', 'åˆ†çº¢'] },
                { id: 'investment', name: 'æŠ•èµ„ç†è´¢', icon: 'ğŸ“ˆ', keywords: ['ç†è´¢', 'åŸºé‡‘', 'è‚¡ç¥¨', 'è¯åˆ¸', 'åˆ©æ¯', 'è‚¡æ¯'] },
                { id: 'parttime', name: 'å…¼èŒå¤–å¿«', icon: 'ğŸ’¼', keywords: ['å…¼èŒ', 'åŠ³åŠ¡', 'è¿˜æ¬¾', 'é€€æ¬¾', 'é—²é±¼'] },
                { id: 'other_in', name: 'å…¶ä»–æ”¶å…¥', icon: 'ğŸ’', keywords: [] }
            ]
        };

        // Initialize with robust error handling for localStorage
        let transactions = [];
        try {
            const savedData = localStorage.getItem('myBookkeepingData');
            transactions = savedData ? JSON.parse(savedData) : [];
        } catch (e) {
            console.error("Failed to load data:", e);
            transactions = [];
        }

        let currentView = 'dashboard';
        let importDataCache = []; 
        let charts = {};
        let currentEditingId = null;

        // --- Core ---
        function saveToStorage() {
            try {
                localStorage.setItem('myBookkeepingData', JSON.stringify(transactions));
                console.log('Data saved to localStorage successfully.');
            } catch (e) {
                alert('æ•°æ®ä¿å­˜å¤±è´¥ï¼å¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³ã€‚è¯·å°è¯•æ¸…ç†æµè§ˆå™¨ç¼“å­˜ã€‚');
                console.error("Save failed:", e);
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            toast.classList.remove('translate-y-[-150%]');
            setTimeout(() => toast.classList.add('translate-y-[-150%]'), 3000);
        }
        
        function formatCurrency(num) { return new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(num); }
        
        // Format Date: YYYY-MM-DD HH:mm -> MM-DD HH:mm for list, or full for tooltip
        function formatDateTimeDisplay(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr; // fallback
            // Format to YYYY-MM-DD HH:mm for list
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hour = String(d.getHours()).padStart(2, '0');
            const minute = String(d.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        function matchCategory(name, type) {
            const list = CATEGORIES[type];
            for (const cat of list) {
                if (cat.keywords.some(k => name.includes(k))) return cat;
            }
            return type === 'expense' ? list.find(c => c.id === 'other') : list.find(c => c.id === 'other_in');
        }

        // --- Router ---
        function router(view) {
            currentView = view;
            if (view !== 'analysis') {
                Object.values(charts).forEach(c => c.destroy());
                charts = {};
                document.getElementById('analysis-filter').classList.add('hidden');
            } else {
                document.getElementById('analysis-filter').classList.remove('hidden');
                const picker = document.getElementById('analysis-month-picker');
                if(!picker.value) {
                    const now = new Date();
                    picker.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                }
            }
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.className = "nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50 transition-colors");
            const activeBtn = document.getElementById(`nav-${view}`);
            if(activeBtn) activeBtn.className = "nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-colors text-blue-600 bg-blue-50";

            const titles = { 'dashboard': 'æ”¶æ”¯æ¦‚è§ˆ', 'add': 'è®°ä¸€ç¬”', 'import': 'å¯¼å…¥è´¦å•', 'analysis': 'ç»Ÿè®¡åˆ†æ' };
            document.getElementById('page-title').textContent = titles[view];

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '';
            contentArea.classList.remove('fade-in');
            void contentArea.offsetWidth;
            contentArea.classList.add('fade-in');

            if (view === 'dashboard') renderDashboard(contentArea);
            if (view === 'add') renderAddForm(contentArea);
            if (view === 'import') renderImport(contentArea);
            if (view === 'analysis') { renderAnalysis(contentArea); renderAnalysisCharts(); }

            lucide.createIcons();
            if(view === 'import') bindDragEvents();
        }

        // --- Views ---
        function renderDashboard(container) {
            const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            const income = sortedTransactions.filter(t => t.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
            const expense = sortedTransactions.filter(t => t.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);
            const balance = income - expense;

            container.innerHTML = `
                <div class="grid grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl p-6 text-white shadow-lg shadow-blue-200">
                        <div class="flex items-center gap-2 mb-2 opacity-80">
                            <i data-lucide="wallet" class="w-4 h-4"></i>
                            <span class="text-sm">æ€»èµ„äº§</span>
                        </div>
                        <div class="text-3xl font-bold">${formatCurrency(balance)}</div>
                    </div>
                    <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm flex flex-col justify-center">
                        <div class="flex items-center gap-2 mb-2 text-gray-500">
                            <div class="w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><i data-lucide="trending-up" class="w-3 h-3"></i></div>
                            <span class="text-sm">æ€»æ”¶å…¥</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-800">${formatCurrency(income)}</div>
                    </div>
                    <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm flex flex-col justify-center">
                        <div class="flex items-center gap-2 mb-2 text-gray-500">
                            <div class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center"><i data-lucide="trending-down" class="w-3 h-3"></i></div>
                            <span class="text-sm">æ€»æ”¯å‡º</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-800">${formatCurrency(expense)}</div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">è¿‘æœŸäº¤æ˜“æ˜ç»†</h3>
                        <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">${sortedTransactions.length} ç¬”è®°å½•</span>
                    </div>
                    ${sortedTransactions.length === 0 ? `
                        <div class="p-12 text-center text-gray-400">
                            <i data-lucide="file-x" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                            <p>æš‚æ— æ•°æ®ï¼Œå¿«å»è®°ä¸€ç¬”å§</p>
                        </div>
                    ` : `
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="px-6 py-4 font-medium">æ—¶é—´</th>
                                    <th class="px-6 py-4 font-medium">åˆ†ç±»</th>
                                    <th class="px-6 py-4 font-medium">å¤‡æ³¨</th>
                                    <th class="px-6 py-4 font-medium">æ”¯ä»˜æ–¹å¼</th>
                                    <th class="px-6 py-4 font-medium text-right">é‡‘é¢</th>
                                    <th class="px-6 py-4 font-medium text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${sortedTransactions.map(t => `
                                    <tr class="hover:bg-gray-50 transition-colors group">
                                        <td class="px-6 py-4 text-gray-500 whitespace-nowrap text-xs font-mono">${formatDateTimeDisplay(t.date)}</td>
                                        <td class="px-6 py-4">
                                            <div onclick="openEditModal(${t.id})" class="flex items-center gap-2 cursor-pointer hover:bg-blue-50 p-2 -ml-2 rounded-lg transition-all group/cat relative w-fit" title="ç‚¹å‡»ä¿®æ”¹åˆ†ç±»">
                                                <span class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-lg group-hover/cat:bg-white group-hover/cat:shadow-sm transition-all">${t.category.icon}</span>
                                                <span class="font-medium text-gray-700 group-hover/cat:text-blue-700">${t.category.name}</span>
                                                <i data-lucide="pencil" class="w-3 h-3 text-blue-400 opacity-0 group-hover/cat:opacity-100 transition-opacity absolute right-[-14px]"></i>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-gray-600 max-w-xs truncate" title="${t.note || ''}">${t.note || '-'}</td>
                                        <td class="px-6 py-4 text-gray-500 text-xs">${t.paymentMethod || '-'}</td>
                                        <td class="px-6 py-4 text-right font-bold ${t.type === 'income' ? 'text-green-600' : 'text-gray-800'}">
                                            ${t.type === 'income' ? '+' : '-'} ${t.amount.toFixed(2)}
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <button onclick="deleteTransaction(${t.id})" class="text-gray-300 hover:text-red-500 transition-colors p-1.5 rounded hover:bg-red-50" title="åˆ é™¤">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            `;
        }

        function renderAnalysis(container) {
            container.innerHTML = `
                <div class="space-y-6 pb-12">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                            <div class="text-gray-400 text-xs font-bold uppercase mb-2">æœ¬æœˆæ”¯å‡º</div>
                            <div class="text-2xl font-bold text-gray-800" id="stat-expense">Â¥0.00</div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                            <div class="text-gray-400 text-xs font-bold uppercase mb-2">æœ¬æœˆæ”¶å…¥</div>
                            <div class="text-2xl font-bold text-green-600" id="stat-income">Â¥0.00</div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                            <div class="text-gray-400 text-xs font-bold uppercase mb-2">ç»“ä½™</div>
                            <div class="text-2xl font-bold text-blue-600" id="stat-balance">Â¥0.00</div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                            <div class="text-gray-400 text-xs font-bold uppercase mb-2">æ—¥å‡æ”¯å‡º</div>
                            <div class="text-2xl font-bold text-orange-500" id="stat-daily">Â¥0.00</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                            <h3 class="font-bold text-gray-700 mb-4">æ”¶æ”¯è¶‹åŠ¿ (æ¯æ—¥)</h3>
                            <div class="h-64"><canvas id="chart-trend"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                            <h3 class="font-bold text-gray-700 mb-4">æ”¯å‡ºæ„æˆ</h3>
                            <div class="h-48 flex justify-center"><canvas id="chart-category"></canvas></div>
                            <div id="category-legend" class="mt-4 space-y-2 max-h-40 overflow-y-auto text-sm"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                            <h3 class="font-bold text-gray-700 mb-4">æ”¯å‡ºåˆ†ç±»æ’è¡Œæ¦œ</h3>
                            <div id="ranking-list" class="space-y-4"></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                            <h3 class="font-bold text-gray-700 mb-4">å¤§é¢æ¶ˆè´¹ TOP 5</h3>
                            <div id="top-transactions" class="space-y-0 divide-y divide-gray-50"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAnalysisCharts() {
            const picker = document.getElementById('analysis-month-picker');
            if(!picker) return;
            const [year, month] = picker.value.split('-').map(Number);
            const monthlyData = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getFullYear() === year && (d.getMonth() + 1) === month;
            });

            const totalExp = monthlyData.filter(t => t.type === 'expense').reduce((a, b) => a + b.amount, 0);
            const totalInc = monthlyData.filter(t => t.type === 'income').reduce((a, b) => a + b.amount, 0);
            const daysInMonth = new Date(year, month, 0).getDate();
            const dailyAvg = daysInMonth > 0 ? totalExp / daysInMonth : 0;

            document.getElementById('stat-expense').textContent = formatCurrency(totalExp);
            document.getElementById('stat-income').textContent = formatCurrency(totalInc);
            document.getElementById('stat-balance').textContent = formatCurrency(totalInc - totalExp);
            document.getElementById('stat-daily').textContent = formatCurrency(dailyAvg);

            const daysMap = new Array(daysInMonth).fill(0).map((_, i) => ({ day: i + 1, expense: 0, income: 0 }));
            monthlyData.forEach(t => {
                const d = new Date(t.date).getDate();
                if(d <= daysInMonth) {
                    if(t.type === 'expense') daysMap[d-1].expense += t.amount;
                    else daysMap[d-1].income += t.amount;
                }
            });

            const catMap = {};
            monthlyData.filter(t => t.type === 'expense').forEach(t => {
                if(!catMap[t.category.id]) catMap[t.category.id] = { ...t.category, amount: 0 };
                catMap[t.category.id].amount += t.amount;
            });
            const sortedCats = Object.values(catMap).sort((a, b) => b.amount - a.amount);

            if(charts.trend) charts.trend.destroy();
            const ctxTrend = document.getElementById('chart-trend').getContext('2d');
            charts.trend = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: daysMap.map(d => `${d.day}æ—¥`),
                    datasets: [
                        { label: 'æ”¯å‡º', data: daysMap.map(d => d.expense), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', borderWidth: 2, tension: 0.3, fill: true, pointRadius: 2 },
                        { label: 'æ”¶å…¥', data: daysMap.map(d => d.income), borderColor: '#22c55e', backgroundColor: 'transparent', borderWidth: 2, tension: 0.3, borderDash: [5, 5], pointRadius: 0 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top', align: 'end' } }, scales: { y: { beginAtZero: true, grid: { borderDash: [2, 2] } }, x: { grid: { display: false } } } }
            });

            if(charts.category) charts.category.destroy();
            if(sortedCats.length > 0) {
                const ctxCat = document.getElementById('chart-category').getContext('2d');
                charts.category = new Chart(ctxCat, {
                    type: 'doughnut',
                    data: {
                        labels: sortedCats.map(c => c.name),
                        datasets: [{ data: sortedCats.map(c => c.amount), backgroundColor: ['#3b82f6', '#f97316', '#10b981', '#8b5cf6', '#ec4899', '#6366f1', '#f43f5e'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '70%' }
                });
            }

            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = sortedCats.length ? sortedCats.map((c, i) => {
                const percent = totalExp > 0 ? (c.amount / totalExp * 100).toFixed(1) : 0;
                return `
                    <div class="flex flex-col gap-1">
                        <div class="flex justify-between text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 w-4 font-bold">${i + 1}</span>
                                <span class="text-gray-700">${c.icon} ${c.name}</span>
                            </div>
                            <div class="flex gap-4">
                                <span class="font-bold text-gray-800">Â¥${c.amount.toFixed(2)}</span>
                                <span class="text-gray-400 w-10 text-right">${percent}%</span>
                            </div>
                        </div>
                        <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('') : '<div class="text-center text-gray-400 py-4">æœ¬æœˆæš‚æ— æ”¯å‡ºè®°å½•</div>';

            const topTx = monthlyData.filter(t => t.type === 'expense').sort((a, b) => b.amount - a.amount).slice(0, 5);
            document.getElementById('top-transactions').innerHTML = topTx.length ? topTx.map(t => `
                <div class="flex items-center justify-between py-3">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-sm">${t.category.icon}</div>
                        <div>
                            <div class="font-medium text-gray-800 text-sm truncate max-w-[120px]" title="${t.note}">${t.note}</div>
                            <div class="text-xs text-gray-400">${t.date}</div>
                        </div>
                    </div>
                    <div class="font-bold text-gray-800">- Â¥${t.amount.toFixed(2)}</div>
                </div>
            `).join('') : '<div class="text-center text-gray-400 py-4">æœ¬æœˆæš‚æ— æ”¯å‡ºè®°å½•</div>';
        }

        function renderAddForm(container) {
            // Pre-fill with current date-time local
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);

            container.innerHTML = `
                <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                    <form id="add-form" onsubmit="handleAddSubmit(event)">
                        <div class="flex bg-gray-100 p-1 rounded-xl mb-8">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="type" value="expense" checked class="peer hidden" onchange="updateCategories('expense')">
                                <div class="py-3 text-center rounded-lg font-medium text-gray-500 peer-checked:bg-white peer-checked:text-gray-900 peer-checked:shadow-sm transition-all">æ”¯å‡º</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="type" value="income" class="peer hidden" onchange="updateCategories('income')">
                                <div class="py-3 text-center rounded-lg font-medium text-gray-500 peer-checked:bg-white peer-checked:text-green-600 peer-checked:shadow-sm transition-all">æ”¶å…¥</div>
                            </label>
                        </div>
                        <div class="mb-8">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">é‡‘é¢ (CNY)</label>
                            <div class="relative"><span class="absolute left-0 top-1/2 -translate-y-1/2 text-3xl font-bold text-gray-400">Â¥</span><input type="number" step="0.01" name="amount" required placeholder="0.00" class="w-full pl-8 py-2 text-4xl font-bold text-gray-800 border-b-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-transparent placeholder-gray-200 transition-colors"></div>
                        </div>
                        <div class="mb-8"><label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">åˆ†ç±»</label><div id="category-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-3"></div><input type="hidden" name="category_id" id="selected-category-id" required></div>
                        
                        <div class="mb-8">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">æ”¯ä»˜æ–¹å¼ (é€‰å¡«)</label>
                            <input type="text" name="paymentMethod" placeholder="ä¾‹å¦‚ï¼šå¾®ä¿¡é›¶é’±ã€æ‹›å•†é“¶è¡Œä¿¡ç”¨å¡" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all">
                        </div>

                        <div class="grid grid-cols-2 gap-6 mb-8">
                            <div><label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">æ—¥æœŸ & æ—¶é—´</label><input type="datetime-local" name="date" required value="${localISOTime}" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all"></div>
                            <div><label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">å¤‡æ³¨</label><input type="text" name="note" placeholder="å†™ç‚¹ä»€ä¹ˆ..." class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all"></div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition-all transform active:scale-[0.98]">ä¿å­˜è®°å½•</button>
                    </form>
                </div>
            `;
            updateCategories('expense');
        }

        function renderImport(container) {
            container.innerHTML = `
                <div class="max-w-4xl mx-auto space-y-8">
                    <div id="import-step-1" class="bg-white rounded-2xl p-8 shadow-sm border border-gray-200">
                        <div class="flex items-start gap-4 mb-6">
                            <div class="bg-blue-50 p-3 rounded-xl text-blue-600"><i data-lucide="file-spreadsheet" class="w-6 h-6"></i></div>
                            <div><h3 class="text-lg font-bold text-gray-800">ä¸Šä¼ è´¦å•æ–‡ä»¶</h3><p class="text-sm text-gray-500 mt-1">æ”¯æŒ å¾®ä¿¡(.xlsx)/æ”¯ä»˜å®(.csv)/å·¥è¡Œ(.csv, .pdf) æ–‡ä»¶ã€‚</p></div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <label class="cursor-pointer">
                                <input type="radio" name="source" value="wechat" checked class="peer hidden">
                                <div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:bg-gray-50 transition-all flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-green-200 flex items-center justify-center text-green-700 font-bold">å¾®</div><span class="font-bold">å¾®ä¿¡æ”¯ä»˜</span></div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="source" value="alipay" class="peer hidden">
                                <div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:bg-gray-50 transition-all flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-200 flex items-center justify-center text-blue-700 font-bold">æ”¯</div><span class="font-bold">æ”¯ä»˜å®</span></div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="source" value="icbc" class="peer hidden">
                                <div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:bg-gray-50 transition-all flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-red-200 flex items-center justify-center text-red-700 font-bold">å·¥</div><span class="font-bold">å·¥è¡Œä¿¡ç”¨å¡</span></div>
                            </label>
                        </div>
                        <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-2xl h-48 flex flex-col items-center justify-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all relative">
                            <input type="file" id="file-upload" accept=".csv, .xlsx, .xls, .pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(event)">
                            <i data-lucide="upload-cloud" class="w-10 h-10 text-gray-400 mb-3 pointer-events-none"></i>
                            <p class="text-gray-600 font-medium pointer-events-none">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶</p>
                            <p class="text-xs text-gray-400 mt-1 pointer-events-none">æ”¯æŒ .xlsx / .csv / .pdf æ ¼å¼</p>
                        </div>
                    </div>
                    <div id="import-preview" class="hidden bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-green-50">
                            <div class="flex items-center gap-2 text-green-800"><i data-lucide="check-circle" class="w-5 h-5"></i><span class="font-bold">è§£ææˆåŠŸï¼šå…± <span id="preview-count">0</span> æ¡è®°å½•</span></div>
                            <button onclick="resetImport()" class="text-sm text-gray-500 hover:text-gray-700">é‡æ–°ä¸Šä¼ </button>
                        </div>
                        <div class="max-h-[400px] overflow-y-auto p-0"><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-500 sticky top-0"><tr><th class="px-6 py-3">æ—¥æœŸæ—¶é—´</th><th class="px-6 py-3">åˆ†ç±»</th><th class="px-6 py-3">å¤‡æ³¨</th><th class="px-6 py-3">æ”¯ä»˜æ–¹å¼</th><th class="px-6 py-3 text-right">é‡‘é¢</th></tr></thead><tbody id="preview-tbody" class="divide-y divide-gray-100"></tbody></table></div>
                        <div class="p-6 border-t border-gray-100 bg-gray-50 text-right"><button onclick="commitImport()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-green-200 transition-all">ç¡®è®¤å¯¼å…¥å…¨éƒ¨</button></div>
                    </div>
                </div>
            `;
        }
        
        function bindDragEvents() {
            const dropZone = document.getElementById('drop-zone');
            if(!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, e => {e.preventDefault(); e.stopPropagation();}, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-active'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-active'), false);
            });

            dropZone.addEventListener('drop', e => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if(files.length > 0) handleFileProcess(files[0]);
            }, false);
        }

        // --- Data Logic ---
        function updateCategories(type) {
            let currentActiveCategories = CATEGORIES[type];
            document.getElementById('selected-category-id').value = currentActiveCategories[0].id;
            document.getElementById('category-grid').innerHTML = currentActiveCategories.map((cat, index) => `
                <div onclick="selectCategory('${cat.id}')" id="cat-${cat.id}" class="cursor-pointer flex flex-col items-center justify-center p-3 rounded-xl border transition-all ${index === 0 ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:bg-gray-50 text-gray-600'}">
                    <div class="text-2xl mb-1">${cat.icon}</div><div class="text-xs font-medium">${cat.name}</div>
                </div>
            `).join('');
        }

        function selectCategory(id) {
            document.getElementById('selected-category-id').value = id;
            document.querySelectorAll('[id^="cat-"]').forEach(el => el.className = el.id === `cat-${id}` ? "cursor-pointer flex flex-col items-center justify-center p-3 rounded-xl border transition-all border-blue-500 bg-blue-50 text-blue-700" : "cursor-pointer flex flex-col items-center justify-center p-3 rounded-xl border transition-all border-gray-200 hover:bg-gray-50 text-gray-600");
        }

        function handleAddSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const type = formData.get('type');
            const catId = formData.get('category_id');
            const amount = parseFloat(formData.get('amount'));
            if (!amount || amount <= 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
            
            // Note: input type=datetime-local returns YYYY-MM-DDTHH:mm
            const dateVal = formData.get('date');
            
            transactions.unshift({ 
                id: Date.now(), 
                type, 
                amount, 
                category: CATEGORIES[type].find(c => c.id === catId), 
                date: dateVal, 
                note: formData.get('note') || '',
                paymentMethod: formData.get('paymentMethod') || '' 
            });
            saveToStorage(); 
            showToast('è®°è´¦æˆåŠŸï¼'); 
            router('dashboard');
        }

        function deleteTransaction(id) {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) { 
                transactions = transactions.filter(t => t.id !== id); 
                saveToStorage(); 
                if(currentView === 'dashboard') renderDashboard(document.getElementById('content-area')); 
                showToast('å·²åˆ é™¤è®°å½•'); 
                lucide.createIcons(); 
            }
        }

        // --- Edit Modal Logic ---
        function openEditModal(id) {
            const t = transactions.find(x => x.id === id);
            if(!t) return;
            currentEditingId = id;
            const cats = CATEGORIES[t.type];
            const grid = document.getElementById('edit-category-grid');
            grid.innerHTML = cats.map(cat => `
                <div onclick="applyEditCategory('${cat.id}')" 
                     class="cursor-pointer flex flex-col items-center justify-center p-3 rounded-xl border transition-all ${cat.id === t.category.id ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:bg-gray-50 text-gray-600 hover:scale-105'}"
                     id="edit-cat-${cat.id}">
                    <div class="text-2xl mb-1">${cat.icon}</div>
                    <div class="text-xs font-medium">${cat.name}</div>
                </div>
            `).join('');
            document.getElementById('edit-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            currentEditingId = null;
        }

        function applyEditCategory(catId) {
            if (!currentEditingId) return;
            const tIndex = transactions.findIndex(x => x.id === currentEditingId);
            if (tIndex === -1) return;
            const t = transactions[tIndex];
            const newCategory = CATEGORIES[t.type].find(c => c.id === catId);
            if (newCategory) {
                transactions[tIndex].category = newCategory;
                saveToStorage();
                showToast('ä¿®æ”¹æˆåŠŸ');
                if (currentView === 'dashboard') {
                    renderDashboard(document.getElementById('content-area'));
                    lucide.createIcons();
                }
            }
            closeEditModal();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            handleFileProcess(file);
        }

        function handleFileProcess(file) {
            const source = document.querySelector('input[name="source"]:checked').value;
            const fileName = file.name.toLowerCase();

            if (fileName.endsWith('.pdf')) {
                readPDF(file, source);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                readExcel(file, source);
            } else {
                let encoding = (source === 'alipay' || source === 'icbc') ? 'GBK' : 'UTF-8';
                attemptRead(file, source, encoding, false);
            }
        }

        // --- PDF Reader ---
        function readPDF(file, source) {
            const fileReader = new FileReader();
            fileReader.onload = async function() {
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = "";
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(" ");
                        fullText += pageText + "\n";
                    }
                    
                    processPDFText(fullText, source);
                } catch (err) {
                    alert('PDF è§£æå¤±è´¥: ' + err.message);
                    console.error(err);
                }
            };
            fileReader.readAsArrayBuffer(file);
        }

        function processPDFText(text, source) {
            const newTrans = [];
            const cleanText = text.replace(/\s+/g, ' ');
            
            // Improved regex to capture date AND time: YYYY-MM-DD HH:mm:ss
            const dateRegex = /(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2}:\d{2})?/;
            const chunks = cleanText.split(dateRegex);
            
            // split output: [prefix, date1, time1, suffix1/prefix2, date2, time2, ...]
            // Loop step 3: 
            // i=1 (date), i+1 (time), i+2 (content)
            
            for (let i = 1; i < chunks.length; i += 3) {
                const datePart = chunks[i];
                const timePart = chunks[i+1]; 
                const content = chunks[i+2];
                if (!content) continue;

                // Construct full Date string
                let fullDateStr = datePart;
                if(timePart) {
                    fullDateStr += ' ' + timePart;
                } else {
                    fullDateStr += ' 00:00:00';
                }

                // Parse Amount
                const amountMatch = content.match(/(\d+\.\d{2})/);
                if (!amountMatch) continue;
                const amountRaw = parseFloat(amountMatch[0]);

                let type = 'expense';
                if (content.includes('è´·') || content.includes('è¿˜æ¬¾') || content.includes('é€€æ¬¾')) {
                    type = 'income';
                } else if (content.includes('å€Ÿ') || content.includes('æ¶ˆè´¹')) {
                    type = 'expense';
                }

                let note = 'å·¥è¡Œäº¤æ˜“';
                const abstractMatch = content.match(/(æ¶ˆè´¹|é€€æ¬¾|è¿˜æ¬¾)\s+(.*)/);
                if (abstractMatch && abstractMatch[2]) {
                    note = abstractMatch[2].substring(0, 20).trim(); 
                } else {
                    if(content.includes('æ¶ˆè´¹')) note = 'æ¶ˆè´¹';
                    if(content.includes('é€€æ¬¾')) note = 'é€€æ¬¾';
                }

                newTrans.push({
                    id: Date.now() + Math.random(),
                    type,
                    amount: amountRaw,
                    category: matchCategory(note, type),
                    date: fullDateStr,
                    note,
                    paymentMethod: 'å·¥è¡Œä¿¡ç”¨å¡'
                });
            }

            if (newTrans.length === 0) {
                alert('æœªè§£æåˆ°æœ‰æ•ˆè®°å½•ï¼Œè¯·ç¡®è®¤æ˜¯å·¥è¡Œä¿¡ç”¨å¡ PDF è´¦å•');
                return;
            }

            importDataCache = newTrans;
            showPreview();
        }

        // --- Excel Reader ---
        function readExcel(file, source) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const csvText = XLSX.utils.sheet_to_csv(worksheet);
                    processCSV(csvText, source);
                } catch (err) {
                    alert('Excel è§£æå¤±è´¥ï¼š' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- CSV Reader ---
        function attemptRead(file, source, encoding, isRetry) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try { processCSV(e.target.result, source); } catch (err) {
                    if (!isRetry) {
                        const nextEncoding = encoding === 'GBK' ? 'UTF-8' : 'GBK';
                        console.warn(`Retry with ${nextEncoding}...`);
                        attemptRead(file, source, nextEncoding, true);
                    } else { alert(`è§£æå¤±è´¥ï¼š\n${err.message}`); }
                }
            };
            reader.readAsText(file, encoding);
        }

        function processCSV(text, source) {
            const lines = text.split('\n');
            const newTrans = [];
            
            let headerIndex = -1;
            for(let i=0; i<lines.length && i<50; i++) {
                if(lines[i].includes('é‡‘é¢') && (lines[i].includes('æ—¶é—´') || lines[i].includes('æ—¥æœŸ'))) {
                    headerIndex = i;
                    break;
                }
            }

            if (headerIndex === -1) throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¡¨å¤´è¡Œï¼ˆéœ€åŒ…å«â€œæ—¶é—´â€å’Œâ€œé‡‘é¢â€ï¼‰');

            const headerRow = lines[headerIndex].split(',').map(c => c.trim().replace(/"/g, ''));
            const getColIdx = (keywords) => headerRow.findIndex(h => keywords.some(k => h.includes(k)));

            const idxDate = getColIdx(['æ—¶é—´', 'æ—¥æœŸ']);
            const idxAmount = getColIdx(['é‡‘é¢']);
            const idxType = getColIdx(['æ”¶/æ”¯', 'æ”¶æ”¯', 'ç±»å‹']);
            const idxNote = getColIdx(['å•†å“è¯´æ˜', 'å•†å“', 'åç§°']) !== -1 ? getColIdx(['å•†å“è¯´æ˜', 'å•†å“', 'åç§°']) : getColIdx(['äº¤æ˜“å¯¹æ–¹', 'å¯¹æ–¹', 'å•†æˆ·', 'æ‘˜è¦', 'è¯´æ˜']);
            const idxMethod = getColIdx(['æ”¯ä»˜æ–¹å¼', 'æ”¶/ä»˜æ¬¾æ–¹å¼', 'ä»˜æ¬¾æ–¹å¼']);

            if (idxDate === -1 || idxAmount === -1) throw new Error('è¡¨å¤´ç¼ºå¤±å…³é”®åˆ—ï¼ˆæ—¶é—´æˆ–é‡‘é¢ï¼‰');

            for (let i = headerIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const cols = line.split(',').map(c => c.trim().replace(/"/g, '')); 
                if (!cols[idxDate] || !cols[idxAmount]) continue;

                // Date Parsing with Time
                // Wechat: "2025-10-15 08:01:47" -> Preserve
                // Alipay: "2025-09-24 05:58:13" -> Preserve
                // ICBC CSV might be just date, we'll see.
                let dateStr = cols[idxDate].trim();
                
                // If excel converted format to 2025/12/17
                if (dateStr.includes('/')) dateStr = dateStr.replace(/\//g, '-');
                
                // If it looks like a full datetime, keep it.
                // Regex for YYYY-MM-DD HH:mm:ss
                const dateTimeMatch = dateStr.match(/\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{1,2}:\d{1,2}/);
                
                let finalDate = dateStr;
                if (dateTimeMatch) {
                    finalDate = dateTimeMatch[0];
                } else {
                    // Fallback for simple date or weird formats
                    // Fix for common "12-17" format in bank exports -> Add current year
                    if (/^\d{1,2}-\d{1,2}$/.test(dateStr)) {
                        dateStr = new Date().getFullYear() + '-' + dateStr;
                    }
                    const simpleDateMatch = dateStr.match(/\d{4}-\d{1,2}-\d{1,2}/);
                    if (simpleDateMatch) {
                        finalDate = simpleDateMatch[0] + ' 00:00:00';
                    }
                }

                // Fix for Currency Symbols (remove Â¥ and commas)
                let amountStr = cols[idxAmount].replace(/[Â¥,]/g, '').trim();
                let amountRaw = parseFloat(amountStr);
                if (isNaN(amountRaw)) continue;

                let note = (idxNote !== -1 && cols[idxNote]) ? cols[idxNote] : 'äº¤æ˜“';
                if(note === '/' || !note) note = 'äº¤æ˜“';

                let method = '';
                if (source === 'icbc') {
                    method = 'å·¥è¡Œä¿¡ç”¨å¡';
                } else if (idxMethod !== -1 && cols[idxMethod]) {
                    method = cols[idxMethod].replace('/', '');
                }

                let type = 'expense';
                let amount = Math.abs(amountRaw);
                let typeStr = idxType !== -1 ? cols[idxType] : '';

                if (typeStr.includes('æ”¶å…¥') || typeStr.includes('è¿˜æ¬¾') || typeStr.includes('é€€æ¬¾')) {
                    type = 'income';
                } else if (typeStr.includes('æ”¯å‡º') || typeStr.includes('æ¶ˆè´¹')) {
                    type = 'expense';
                } else {
                    if (amountRaw > 0 && source === 'icbc' && !note.includes('é€€æ¬¾')) {
                        if (note.includes('é€€æ¬¾') || note.includes('è¿˜æ¬¾')) type = 'income';
                    }
                }
                
                if (typeStr.includes('ä¸è®¡æ”¶æ”¯')) {
                     if (note.includes('æ”¶ç›Š') || note.includes('èµå›')) type = 'income';
                     else type = 'expense'; 
                }

                if (amount > 0) {
                    newTrans.push({
                        id: Date.now() + Math.random(),
                        type,
                        amount,
                        category: matchCategory(note, type),
                        date: finalDate,
                        note,
                        paymentMethod: method 
                    });
                }
            }

            if (newTrans.length === 0) throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆäº¤æ˜“è®°å½•');
            importDataCache = newTrans;
            showPreview();
        }

        function showPreview() {
            document.getElementById('import-step-1').classList.add('hidden');
            document.getElementById('import-preview').classList.remove('hidden');
            document.getElementById('preview-count').textContent = importDataCache.length;
            document.getElementById('preview-tbody').innerHTML = importDataCache.slice(0, 50).map(t => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-3 text-gray-500 text-xs">${formatDateTimeDisplay(t.date)}</td>
                    <td class="px-6 py-3 flex items-center gap-2"><span>${t.category.icon}</span><span class="text-gray-700">${t.category.name}</span></td>
                    <td class="px-6 py-3 text-gray-500 max-w-[200px] truncate" title="${t.note}">${t.note}</td>
                    <td class="px-6 py-3 text-gray-500 text-xs">${t.paymentMethod || '-'}</td>
                    <td class="px-6 py-3 text-right font-bold ${t.type === 'income' ? 'text-green-600' : 'text-gray-800'}">${t.type === 'income' ? '+' : '-'} ${t.amount}</td>
                </tr>
            `).join('') + (importDataCache.length > 50 ? `<tr><td colspan="5" class="text-center py-4 text-gray-400">...è¿˜æœ‰ ${importDataCache.length - 50} æ¡...</td></tr>` : '');
        }

        function resetImport() {
            importDataCache = [];
            document.getElementById('import-step-1').classList.remove('hidden');
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('file-upload').value = '';
            document.getElementById('drop-zone').classList.remove('drag-active');
        }

        function commitImport() {
            transactions = [...importDataCache, ...transactions];
            saveToStorage(); // Force save to local storage
            showToast(`æˆåŠŸå¯¼å…¥ ${importDataCache.length} æ¡æ•°æ®`); 
            router('dashboard');
        }

        document.getElementById('current-date').textContent = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        router('dashboard');
    </script>
</body>
</html>