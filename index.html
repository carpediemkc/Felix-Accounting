<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººè®°è´¦åŠ©æ‰‹ (PCç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        neon: { blue: '#3b82f6', purple: '#8b5cf6', cyan: '#06b6d4', green: '#10b981' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background-color: #020617; color: #e2e8f0; }
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .glow-text { text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .nav-active { background: rgba(59, 130, 246, 0.15) !important; color: #60a5fa !important; border-left: 3px solid #60a5fa; text-shadow: 0 0 8px rgba(59, 130, 246, 0.4); }
        .drag-active { border-color: #60a5fa !important; background-color: rgba(59, 130, 246, 0.1) !important; box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-cyan-500/30 selection:text-cyan-200">

    <!-- Ambient Background Glow -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-blue-900/20 rounded-full blur-[150px]"></div>
        <div class="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-purple-900/20 rounded-full blur-[150px]"></div>
    </div>

    <!-- Sidebar -->
    <aside class="w-72 bg-slate-900/80 backdrop-blur-xl flex-shrink-0 flex flex-col border-r border-slate-800 z-20">
        <div class="p-8 flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-cyan-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
                <i data-lucide="wallet" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-bold text-xl text-slate-100 tracking-tight glow-text">Felixè´¦æœ¬</h1>
                <p class="text-xs text-slate-500 font-mono tracking-wider mt-1">FINANCE OS v2.8</p>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-2 overflow-y-auto py-4">
            <button onclick="router('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-4 px-5 py-3.5 text-sm font-medium rounded-r-xl transition-all duration-200 text-slate-400 hover:text-slate-100 hover:bg-slate-800/50">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
                æ”¶æ”¯æ¦‚è§ˆ
            </button>
            <button onclick="router('analysis')" id="nav-analysis" class="nav-btn w-full flex items-center gap-4 px-5 py-3.5 text-sm font-medium rounded-r-xl transition-all duration-200 text-slate-400 hover:text-slate-100 hover:bg-slate-800/50">
                <i data-lucide="pie-chart" class="w-5 h-5"></i>
                æ•°æ®åˆ†æ
            </button>
            <button onclick="router('add')" id="nav-add" class="nav-btn w-full flex items-center gap-4 px-5 py-3.5 text-sm font-medium rounded-r-xl transition-all duration-200 text-slate-400 hover:text-slate-100 hover:bg-slate-800/50">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                å¿«é€Ÿè®°è´¦
            </button>
            <button onclick="router('import')" id="nav-import" class="nav-btn w-full flex items-center gap-4 px-5 py-3.5 text-sm font-medium rounded-r-xl transition-all duration-200 text-slate-400 hover:text-slate-100 hover:bg-slate-800/50">
                <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                è´¦å•å¯¼å…¥
            </button>
        </nav>

        <div class="p-6 space-y-4">
            <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50 text-center backdrop-blur-sm">
                <div class="flex items-center justify-center gap-2 mb-2 text-cyan-400">
                    <i data-lucide="hard-drive" class="w-4 h-4"></i>
                    <span class="text-[10px] font-bold uppercase tracking-widest">LOCAL STORAGE</span>
                </div>
                <p class="text-xs text-slate-500">æ•°æ®åŠ å¯†å­˜å‚¨äºæœ¬åœ°<br>è¯·å‹¿éšæ„æ¸…é™¤ç¼“å­˜</p>
            </div>
            
            <button onclick="requestClearAllData()" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl border border-rose-900/30 bg-rose-500/10 text-rose-400 hover:bg-rose-500/20 hover:text-rose-300 transition-all text-xs font-bold uppercase tracking-wider group">
                <i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                æ¸…ç©ºæ‰€æœ‰æ•°æ®
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <!-- Top Bar -->
        <header class="h-20 flex items-center justify-between px-10 flex-shrink-0 z-10">
            <div class="flex items-center gap-6">
                <h2 id="page-title" class="text-2xl font-bold text-slate-100 tracking-tight">æ§åˆ¶å°</h2>
                <div id="analysis-filter" class="hidden transform transition-all hover:scale-105">
                    <input type="month" id="analysis-month-picker" onchange="renderAnalysisCharts()" class="bg-slate-800 border border-slate-700 text-sm rounded-lg px-4 py-1.5 outline-none focus:ring-2 focus:ring-blue-500/50 font-mono text-slate-300 shadow-lg">
                </div>
            </div>
            <div class="flex items-center gap-3 bg-slate-800/80 px-4 py-2 rounded-full border border-slate-700/50 shadow-lg backdrop-blur-md">
                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <div class="text-xs font-mono text-slate-400" id="current-date"></div>
            </div>
        </header>

        <!-- Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto px-10 pb-10 fade-in custom-scrollbar">
            <!-- Dynamic Content -->
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 right-6 bg-slate-800/90 text-white px-6 py-4 rounded-xl shadow-2xl shadow-black/50 border border-slate-700/50 backdrop-blur-xl transform translate-y-[-200%] transition-all duration-500 z-50 flex items-center gap-3 font-medium pointer-events-none">
        <div class="bg-emerald-500/20 text-emerald-400 rounded-full p-1"><i data-lucide="check" class="w-4 h-4"></i></div>
        <span id="toast-msg">æ“ä½œæˆåŠŸ</span>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-[60] flex items-center justify-center fade-in">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-sm shadow-2xl transform transition-all scale-100">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-10 h-10 rounded-full bg-rose-500/20 flex items-center justify-center text-rose-500 shrink-0">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-slate-100">ç¡®è®¤æ“ä½œï¼Ÿ</h3>
                    <p class="text-sm text-slate-400" id="confirm-msg">æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
                </div>
            </div>
            <div class="flex gap-3 justify-end mt-6">
                <button onclick="closeConfirmModal()" class="px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-slate-200 hover:bg-slate-800 transition-colors">å–æ¶ˆ</button>
                <button id="confirm-btn-action" class="px-4 py-2 rounded-lg text-sm font-bold bg-rose-600 hover:bg-rose-700 text-white shadow-lg shadow-rose-900/50 transition-all">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center fade-in">
        <div class="bg-slate-900 border border-slate-800 rounded-3xl p-8 w-full max-w-lg m-4 shadow-2xl shadow-blue-900/20 transform transition-all scale-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-blue-600/10 rounded-full blur-[80px] -mr-16 -mt-16 pointer-events-none"></div>
            <div class="flex justify-between items-center mb-8 relative z-10">
                <h3 class="text-xl font-bold text-slate-100 flex items-center gap-2">
                    <i data-lucide="tag" class="w-5 h-5 text-blue-400"></i>
                    ä¿®æ”¹åˆ†ç±»
                </h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-white hover:bg-slate-800 transition-all p-2 rounded-full">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="edit-category-grid" class="grid grid-cols-4 gap-4 mb-2 relative z-10"></div>
            <input type="hidden" id="edit-transaction-id">
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        // ChartJS Dark Mode Defaults
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';
        
        // --- Data & Config ---
        const CATEGORIES = {
            expense: [
                { id: 'food', name: 'é¤é¥®ç¾é£Ÿ', icon: 'ğŸ”', keywords: ['é¤é¥®', 'ç¾é£Ÿ', 'é¥¿äº†ä¹ˆ', 'ç¾å›¢', 'éº¦å½“åŠ³', 'è‚¯å¾·åŸº', 'æ˜Ÿå·´å…‹', 'ç‘å¹¸', 'é¥­', 'é¢', 'ç²‰', 'ç²¥', 'åŒ…å­', 'é²œåŒ…', 'çƒ§çƒ¤', 'ç«é”…', 'è¶…å¸‚', 'ä¾¿åˆ©åº—', 'èœ'] },
                { id: 'transport', name: 'äº¤é€šå‡ºè¡Œ', icon: 'ğŸš€', keywords: ['äº¤é€š', 'å‡ºè¡Œ', 'æ»´æ»´', 'æ‰“è½¦', 'è½¦è´¹', 'åœ°é“', 'å…¬äº¤', 'é“è·¯', 'ç«è½¦', 'æœºç¥¨', 'åŠ æ²¹', 'åœè½¦', 'é«˜é€Ÿ', 'ETC'] },
                { id: 'shopping', name: 'è´­ç‰©æ¶ˆè´¹', icon: 'ğŸ›ï¸', keywords: ['è´­ç‰©', 'æ·˜å®', 'äº¬ä¸œ', 'æ‹¼å¤šå¤š', 'å”¯å“ä¼š', 'ä¼˜è¡£åº“', 'ååˆ›ä¼˜å“', 'å±ˆè‡£æ°', 'æœé¥°', 'é‹'] },
                { id: 'entertainment', name: 'ä¼‘é—²å¨±ä¹', icon: 'ğŸ®', keywords: ['å¨±ä¹', 'ç”µå½±', 'æ¸¸æˆ', 'è§†é¢‘', 'ä¼šå‘˜', 'KTV', 'ç½‘å§', 'æŒ‰æ‘©'] },
                { id: 'housing', name: 'å±…ä½ç‰©ä¸š', icon: 'ğŸ ', keywords: ['æˆ¿ç§Ÿ', 'ç‰©ä¸š', 'ç”µè´¹', 'æ°´è´¹', 'ç‡ƒæ°”', 'å®½å¸¦', 'æˆ¿è´·', 'ç»´ä¿®'] },
                { id: 'medical', name: 'åŒ»ç–—å¥åº·', icon: 'ğŸ’Š', keywords: ['åŒ»ç–—', 'åŒ»é™¢', 'è¯æˆ¿', 'è¯åº—', 'æŒ‚å·', 'ä½“æ£€'] },
                { id: 'other', name: 'å…¶ä»–æ”¯å‡º', icon: 'ğŸ’¸', keywords: [] }
            ],
            income: [
                { id: 'salary', name: 'å·¥èµ„è–ªæ°´', icon: 'ğŸ’°', keywords: ['å·¥èµ„', 'è–ªèµ„', 'ä»£å‘'] },
                { id: 'bonus', name: 'å¥–é‡‘è¡¥è´´', icon: 'ğŸ§§', keywords: ['å¥–é‡‘', 'çº¢åŒ…', 'è½¬è´¦'] },
                { id: 'investment', name: 'æŠ•èµ„ç†è´¢', icon: 'ğŸ“ˆ', keywords: ['ç†è´¢', 'åŸºé‡‘', 'è‚¡ç¥¨', 'åˆ©æ¯'] },
                { id: 'parttime', name: 'å…¼èŒå¤–å¿«', icon: 'ğŸ’¼', keywords: ['å…¼èŒ', 'åŠ³åŠ¡', 'è¿˜æ¬¾', 'é€€æ¬¾', 'é—²é±¼'] },
                { id: 'other_in', name: 'å…¶ä»–æ”¶å…¥', icon: 'ğŸ’', keywords: [] }
            ]
        };

        // Initialize Data
        let transactions = [];
        let importedFiles = []; 
        
        try {
            const savedData = localStorage.getItem('myBookkeepingData');
            transactions = savedData ? JSON.parse(savedData) : [];
            const savedFiles = localStorage.getItem('myBookkeepingFiles');
            importedFiles = savedFiles ? JSON.parse(savedFiles) : [];
        } catch (e) { 
            console.error("Failed to load data:", e);
            transactions = [];
            importedFiles = [];
        }

        let currentView = 'dashboard';
        let importDataCache = []; 
        let charts = {};
        let currentEditingId = null;
        let currentFileMeta = null;

        // --- Helpers ---
        function saveToStorage() {
            try {
                localStorage.setItem('myBookkeepingData', JSON.stringify(transactions));
                localStorage.setItem('myBookkeepingFiles', JSON.stringify(importedFiles));
            } catch (e) {
                alert('æ•°æ®ä¿å­˜å¤±è´¥ï¼è¯·æ¸…ç†ç¼“å­˜ã€‚');
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            toast.classList.remove('translate-y-[-200%]');
            setTimeout(() => toast.classList.add('translate-y-[-200%]'), 3000);
        }
        function formatCurrency(num) { return new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(num); }
        function formatDateTimeDisplay(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const h = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return `${m}-${day} <span class="text-slate-600 mx-1">|</span> ${h}:${min}`;
        }
        function matchCategory(name, type) {
            const list = CATEGORIES[type];
            for (const cat of list) if (cat.keywords.some(k => name.includes(k))) return cat;
            return type === 'expense' ? list.find(c => c.id === 'other') : list.find(c => c.id === 'other_in');
        }

        // --- Router ---
        function router(view) {
            currentView = view;
            if (view !== 'analysis') {
                Object.values(charts).forEach(c => c.destroy());
                charts = {};
                document.getElementById('analysis-filter').classList.add('hidden');
            } else {
                document.getElementById('analysis-filter').classList.remove('hidden');
                const picker = document.getElementById('analysis-month-picker');
                if(!picker.value) picker.value = new Date().toISOString().slice(0, 7);
            }
            
            document.querySelectorAll('.nav-btn').forEach(btn => 
                btn.className = "nav-btn w-full flex items-center gap-4 px-5 py-3.5 text-sm font-medium rounded-r-xl transition-all duration-200 text-slate-400 hover:text-slate-100 hover:bg-slate-800/50"
            );
            const activeBtn = document.getElementById(`nav-${view}`);
            if(activeBtn) activeBtn.className = "nav-btn nav-active w-full flex items-center gap-4 px-5 py-3.5 text-sm font-medium rounded-r-xl transition-all duration-200";

            document.getElementById('page-title').textContent = { 'dashboard': 'æ”¶æ”¯æ¦‚è§ˆ', 'add': 'å¿«é€Ÿè®°è´¦', 'import': 'å¯¼å…¥è´¦å•', 'analysis': 'æ•°æ®åˆ†æ' }[view];

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '';
            contentArea.classList.remove('fade-in');
            void contentArea.offsetWidth;
            contentArea.classList.add('fade-in');

            if (view === 'dashboard') renderDashboard(contentArea);
            if (view === 'add') renderAddForm(contentArea);
            if (view === 'import') renderImport(contentArea);
            if (view === 'analysis') { renderAnalysis(contentArea); renderAnalysisCharts(); }

            lucide.createIcons();
            if(view === 'import') bindDragEvents();
        }

        // --- Render: Dashboard ---
        function renderDashboard(container) {
            const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Calculate Monthly Stats - Current Month Only
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            const monthlyTransactions = sortedTransactions.filter(t => {
                const d = new Date(t.date);
                return d.getFullYear() === currentYear && d.getMonth() === currentMonth;
            });

            const monthlyIncome = monthlyTransactions.filter(t => t.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
            const monthlyExpense = monthlyTransactions.filter(t => t.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                    <div class="glass-panel rounded-3xl p-8 shadow-lg hover:bg-slate-800/80 transition-colors flex flex-col justify-center relative overflow-hidden group">
                        <div class="absolute right-6 top-6 p-2 bg-emerald-500/10 rounded-xl text-emerald-400 group-hover:scale-110 transition-transform"><i data-lucide="arrow-up-right" class="w-5 h-5"></i></div>
                        <p class="text-slate-400 text-xs font-bold mb-2 uppercase tracking-wide">æœ¬æœˆæ”¶å…¥</p>
                        <div class="text-3xl font-bold text-slate-100 font-mono">${formatCurrency(monthlyIncome)}</div>
                    </div>
                    <div class="glass-panel rounded-3xl p-8 shadow-lg hover:bg-slate-800/80 transition-colors flex flex-col justify-center relative overflow-hidden group">
                        <div class="absolute right-6 top-6 p-2 bg-rose-500/10 rounded-xl text-rose-400 group-hover:scale-110 transition-transform"><i data-lucide="arrow-down-right" class="w-5 h-5"></i></div>
                        <p class="text-slate-400 text-xs font-bold mb-2 uppercase tracking-wide">æœ¬æœˆæ”¯å‡º</p>
                        <div class="text-3xl font-bold text-slate-100 font-mono">${formatCurrency(monthlyExpense)}</div>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-6 px-2">
                    <h3 class="text-lg font-bold text-slate-200">è¿‘æœŸæ˜ç»†</h3>
                    <span class="text-xs font-mono font-bold text-slate-500 bg-slate-800 border border-slate-700 px-3 py-1 rounded-lg">${sortedTransactions.length} RECORDS</span>
                </div>

                <div class="space-y-3">
                    ${sortedTransactions.length === 0 ? `
                        <div class="flex flex-col items-center justify-center py-24 text-slate-600 border-2 border-dashed border-slate-800 rounded-3xl">
                            <i data-lucide="database" class="w-12 h-12 mb-4 opacity-50"></i>
                            <p class="text-sm">æš‚æ— æ•°æ®ï¼Œå¼€å§‹ç¬¬ä¸€ç¬”è®°å½•å§</p>
                        </div>
                    ` : sortedTransactions.map(t => `
                        <div class="glass-panel rounded-2xl p-4 flex items-center justify-between hover:bg-slate-800 transition-all duration-200 group">
                            <div class="flex items-center gap-5 overflow-hidden">
                                <div class="hidden sm:flex flex-col items-center justify-center w-14 h-14 bg-slate-800 rounded-xl text-slate-400 flex-shrink-0 font-mono text-xs leading-tight border border-slate-700">
                                    <span class="font-bold text-slate-200 text-sm">${new Date(t.date).getDate()}</span>
                                    <span class="text-[10px] uppercase text-slate-500">${new Date(t.date).toLocaleString('en', {month:'short'})}</span>
                                </div>
                                <div onclick="openEditModal('${t.id}')" class="w-12 h-12 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-xl cursor-pointer hover:bg-slate-700 hover:border-blue-500/30 hover:text-blue-400 transition-all relative flex-shrink-0 group/icon" title="ç‚¹å‡»ä¿®æ”¹åˆ†ç±»">
                                    ${t.category.icon}
                                    <div class="absolute -bottom-1 -right-1 bg-slate-900 border border-slate-700 rounded-full p-1 opacity-0 group-hover/icon:opacity-100 transition-opacity">
                                        <i data-lucide="pencil" class="w-2.5 h-2.5 text-blue-400"></i>
                                    </div>
                                </div>
                                <div class="min-w-0">
                                    <div class="flex items-center gap-3 mb-1">
                                        <span onclick="openEditModal('${t.id}')" class="font-bold text-slate-200 truncate group-hover:text-blue-400 transition-colors cursor-pointer hover:underline decoration-blue-500/30 underline-offset-4" title="ç‚¹å‡»ä¿®æ”¹åˆ†ç±»">${t.category.name}</span>
                                        <span class="text-[10px] text-slate-500 bg-slate-900/50 px-2 py-0.5 rounded border border-slate-800">${t.paymentMethod || 'å…¶ä»–'}</span>
                                    </div>
                                    <div class="text-xs text-slate-500 truncate pr-4 flex items-center gap-2">
                                        <span class="font-mono text-[10px] text-slate-600">${new Date(t.date).toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'})}</span>
                                        <span class="w-1 h-1 rounded-full bg-slate-700"></span>
                                        <span class="text-slate-400">${t.note || 'æ— å¤‡æ³¨'}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-6 pl-4 flex-shrink-0">
                                <span class="font-bold text-lg font-mono tracking-tight ${t.type === 'income' ? 'text-emerald-400' : 'text-slate-200'}">
                                    ${t.type === 'income' ? '+' : '-'} ${t.amount.toFixed(2)}
                                </span>
                                <button onclick="requestDeleteTransaction('${t.id}')" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-600 hover:text-rose-400 hover:bg-rose-500/10 transition-all opacity-0 group-hover:opacity-100">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- Render: Add Form ---
        function renderAddForm(container) {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);

            container.innerHTML = `
                <div class="max-w-xl mx-auto mt-8">
                    <div class="glass-panel rounded-3xl p-8 shadow-2xl">
                        <form id="add-form" onsubmit="handleAddSubmit(event)" class="space-y-8">
                            <div class="bg-slate-900 p-1.5 rounded-2xl flex border border-slate-800">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="type" value="expense" checked class="peer hidden" onchange="updateCategories('expense')">
                                    <div class="py-3 text-center rounded-xl font-bold text-slate-500 peer-checked:bg-slate-800 peer-checked:text-slate-100 peer-checked:shadow-lg peer-checked:shadow-black/20 transition-all duration-300">æ”¯å‡º</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="type" value="income" class="peer hidden" onchange="updateCategories('income')">
                                    <div class="py-3 text-center rounded-xl font-bold text-slate-500 peer-checked:bg-slate-800 peer-checked:text-emerald-400 peer-checked:shadow-lg peer-checked:shadow-black/20 transition-all duration-300">æ”¶å…¥</div>
                                </label>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 pl-1">é‡‘é¢</label>
                                <div class="relative group">
                                    <span class="absolute left-0 top-1/2 -translate-y-1/2 text-3xl font-mono text-slate-600 group-focus-within:text-blue-500 transition-colors">Â¥</span>
                                    <input type="number" step="0.01" name="amount" required placeholder="0.00" class="w-full pl-8 py-2 text-5xl font-mono font-bold text-slate-100 border-b-2 border-slate-800 focus:border-blue-500 focus:outline-none bg-transparent placeholder-slate-700 transition-all">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 pl-1">é€‰æ‹©åˆ†ç±»</label>
                                <div id="category-grid" class="grid grid-cols-4 sm:grid-cols-5 gap-3"></div>
                                <input type="hidden" name="category_id" id="selected-category-id" required>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-500 pl-1">æ—¶é—´</label>
                                    <input type="datetime-local" name="date" required value="${localISOTime}" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm font-medium text-slate-200 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all outline-none">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-500 pl-1">æ”¯ä»˜æ–¹å¼</label>
                                    <input type="text" name="paymentMethod" placeholder="å¦‚: å¾®ä¿¡" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm font-medium text-slate-200 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all outline-none">
                                </div>
                                <div class="space-y-2 sm:col-span-2">
                                    <label class="text-xs font-bold text-slate-500 pl-1">å¤‡æ³¨</label>
                                    <input type="text" name="note" placeholder="å†™ç‚¹ä»€ä¹ˆ..." class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm font-medium text-slate-200 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all outline-none">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-600/30 transition-all hover:scale-[1.02] active:scale-[0.98] border border-blue-500/50">
                                ç¡®è®¤è®°å½•
                            </button>
                        </form>
                    </div>
                </div>
            `;
            updateCategories('expense');
        }

        // --- Render: Import ---
        function renderImport(container) {
            container.innerHTML = `
                <div class="max-w-4xl mx-auto space-y-8 mt-4">
                    <div id="import-step-1" class="glass-panel rounded-3xl p-10 shadow-2xl">
                        <div class="text-center mb-10">
                            <div class="w-16 h-16 bg-slate-800 border border-slate-700 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-inner">
                                <i data-lucide="cloud-upload" class="w-8 h-8 text-blue-400"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-100">ä¸Šä¼ è´¦å•æ–‡ä»¶</h3>
                            <p class="text-slate-500 mt-2">æ”¯æŒå¾®ä¿¡ (.xlsx)ã€æ”¯ä»˜å® (.csv) åŠ å·¥å•†é“¶è¡Œ (.csv/.pdf)</p>
                        </div>

                        <div class="grid grid-cols-3 gap-4 mb-8">
                            <label class="cursor-pointer group">
                                <input type="radio" name="source" value="wechat" checked class="peer hidden">
                                <div class="p-4 rounded-2xl border-2 border-slate-700 bg-slate-800/30 peer-checked:border-emerald-500/50 peer-checked:bg-emerald-500/10 hover:bg-slate-800 transition-all flex flex-col items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-emerald-900/50 text-emerald-400 flex items-center justify-center"><i data-lucide="message-circle" class="w-5 h-5"></i></div>
                                    <span class="font-bold text-slate-400 peer-checked:text-emerald-400">å¾®ä¿¡</span>
                                </div>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="source" value="alipay" class="peer hidden">
                                <div class="p-4 rounded-2xl border-2 border-slate-700 bg-slate-800/30 peer-checked:border-blue-500/50 peer-checked:bg-blue-500/10 hover:bg-slate-800 transition-all flex flex-col items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-blue-900/50 text-blue-400 flex items-center justify-center"><i data-lucide="scan-line" class="w-5 h-5"></i></div>
                                    <span class="font-bold text-slate-400 peer-checked:text-blue-400">æ”¯ä»˜å®</span>
                                </div>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="source" value="icbc" class="peer hidden">
                                <div class="p-4 rounded-2xl border-2 border-slate-700 bg-slate-800/30 peer-checked:border-rose-500/50 peer-checked:bg-rose-500/10 hover:bg-slate-800 transition-all flex flex-col items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-rose-900/50 text-rose-400 flex items-center justify-center"><i data-lucide="credit-card" class="w-5 h-5"></i></div>
                                    <span class="font-bold text-slate-400 peer-checked:text-rose-400">å·¥è¡Œä¿¡ç”¨å¡</span>
                                </div>
                            </label>
                        </div>

                        <div id="drop-zone" class="border-2 border-dashed border-slate-700 rounded-3xl h-56 flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-blue-500/5 transition-all relative group bg-slate-800/20">
                            <input type="file" id="file-upload" accept=".csv, .xlsx, .xls, .pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(event)">
                            <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform border border-slate-700">
                                <i data-lucide="plus" class="w-8 h-8 text-slate-400 group-hover:text-blue-400"></i>
                            </div>
                            <p class="text-slate-300 font-bold text-lg group-hover:text-blue-400">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ </p>
                            <p class="text-xs text-slate-500 mt-2">AI æ™ºèƒ½è¯†åˆ«ç¼–ç ä¸æ ¼å¼</p>
                        </div>
                    </div>

                    <div id="import-preview" class="hidden glass-panel rounded-3xl shadow-xl overflow-hidden mb-8">
                        <div class="p-6 border-b border-slate-700/50 flex justify-between items-center bg-emerald-900/20">
                            <div class="flex items-center gap-3 text-emerald-400">
                                <div class="bg-emerald-900/50 p-2 rounded-lg"><i data-lucide="check" class="w-4 h-4"></i></div>
                                <span class="font-bold">è§£ææˆåŠŸï¼š<span id="preview-count" class="text-emerald-300">0</span> æ¡è®°å½•</span>
                            </div>
                            <button onclick="resetImport()" class="text-sm font-bold text-slate-400 hover:text-white transition-colors">é‡æ–°ä¸Šä¼ </button>
                        </div>
                        <div class="max-h-[300px] overflow-y-auto custom-scrollbar"><table class="w-full text-left text-sm text-slate-400"><thead class="bg-slate-800/80 text-slate-300 sticky top-0 font-bold uppercase text-xs tracking-wider"><tr><th class="px-6 py-4">æ—¶é—´</th><th class="px-6 py-4">åˆ†ç±»</th><th class="px-6 py-4">å¤‡æ³¨</th><th class="px-6 py-4">æ”¯ä»˜æ–¹å¼</th><th class="px-6 py-4 text-right">é‡‘é¢</th></tr></thead><tbody id="preview-tbody" class="divide-y divide-slate-800/50"></tbody></table></div>
                        <div class="p-6 border-t border-slate-700/50 bg-slate-800/30 text-right"><button onclick="commitImport()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-10 py-3 rounded-xl font-bold shadow-lg shadow-emerald-900/50 transition-all hover:scale-105 active:scale-95 border border-emerald-500/50">ç¡®è®¤å¯¼å…¥</button></div>
                    </div>

                    <div class="glass-panel rounded-3xl p-8 border border-slate-700/50">
                        <h3 class="font-bold text-slate-100 mb-6 flex items-center gap-2"><i data-lucide="folder-check" class="w-5 h-5 text-blue-400"></i> å·²ä¸Šä¼ æ–‡ä»¶</h3>
                        <div class="space-y-3" id="file-list">
                            ${importedFiles.length === 0 ? '<div class="text-center text-slate-500 py-6 text-sm">æš‚æ— ä¸Šä¼ è®°å½•</div>' : 
                                importedFiles.map(file => `
                                    <div class="flex items-center justify-between bg-slate-800/50 p-4 rounded-xl border border-slate-700 hover:border-slate-600 transition-colors group">
                                        <div class="flex items-center gap-4">
                                            <div class="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center text-slate-300">
                                                <i data-lucide="${file.type === 'pdf' ? 'file-text' : 'file-spreadsheet'}" class="w-5 h-5"></i>
                                            </div>
                                            <div>
                                                <div class="font-bold text-slate-200 text-sm mb-0.5">${file.name}</div>
                                                <div class="text-xs text-slate-500 font-mono">${new Date(file.date).toLocaleString()} â€¢ ${file.count} ç¬”è®°å½•</div>
                                            </div>
                                        </div>
                                        <button onclick="requestDeleteFile('${file.id}')" class="text-slate-500 hover:text-rose-400 p-2 rounded-lg hover:bg-rose-500/10 transition-colors" title="åˆ é™¤æ­¤æ–‡ä»¶åŠç›¸å…³è®°å½•">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Render: Analysis ---
        function renderAnalysis(container) {
            container.innerHTML = `
                <div class="space-y-8 pb-12">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="glass-panel p-6 rounded-3xl flex flex-col justify-between h-32 hover:bg-slate-800 transition-colors">
                            <span class="text-slate-500 text-xs font-extrabold uppercase tracking-widest">æœ¬æœˆæ”¯å‡º</span>
                            <span class="text-3xl font-extrabold text-slate-100 font-mono" id="stat-expense">Â¥0.00</span>
                        </div>
                        <div class="glass-panel p-6 rounded-3xl flex flex-col justify-between h-32 hover:bg-slate-800 transition-colors">
                            <span class="text-slate-500 text-xs font-extrabold uppercase tracking-widest">æœ¬æœˆæ”¶å…¥</span>
                            <span class="text-3xl font-extrabold text-emerald-400 font-mono" id="stat-income">Â¥0.00</span>
                        </div>
                        <div class="glass-panel p-6 rounded-3xl flex flex-col justify-between h-32 hover:bg-slate-800 transition-colors">
                            <span class="text-slate-500 text-xs font-extrabold uppercase tracking-widest">ç»“ä½™</span>
                            <span class="text-3xl font-extrabold text-blue-400 font-mono" id="stat-balance">Â¥0.00</span>
                        </div>
                        <div class="glass-panel p-6 rounded-3xl flex flex-col justify-between h-32 hover:bg-slate-800 transition-colors">
                            <span class="text-slate-500 text-xs font-extrabold uppercase tracking-widest">æ—¥å‡æ”¯å‡º</span>
                            <span class="text-3xl font-extrabold text-orange-400 font-mono" id="stat-daily">Â¥0.00</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 glass-panel p-8 rounded-3xl">
                            <h3 class="font-bold text-slate-100 mb-6 flex items-center gap-2"><i data-lucide="activity" class="w-5 h-5 text-blue-500"></i> æ”¶æ”¯è¶‹åŠ¿</h3>
                            <div class="h-72"><canvas id="chart-trend"></canvas></div>
                        </div>
                        <div class="glass-panel p-8 rounded-3xl">
                            <h3 class="font-bold text-slate-100 mb-6 flex items-center gap-2"><i data-lucide="pie-chart" class="w-5 h-5 text-purple-500"></i> æ”¯å‡ºæ„æˆ</h3>
                            <div class="h-56 flex justify-center mb-4"><canvas id="chart-category"></canvas></div>
                            <div id="category-legend" class="space-y-2 max-h-40 overflow-y-auto text-sm pr-2 custom-scrollbar"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="glass-panel p-8 rounded-3xl">
                            <h3 class="font-bold text-slate-100 mb-6 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-5 h-5 text-cyan-500"></i> æ”¯å‡ºæ’è¡Œæ¦œ</h3>
                            <div id="ranking-list" class="space-y-5"></div>
                        </div>
                        <div class="glass-panel p-8 rounded-3xl">
                            <h3 class="font-bold text-slate-100 mb-6 flex items-center gap-2"><i data-lucide="list" class="w-5 h-5 text-rose-500"></i> å¤§é¢æ¶ˆè´¹ TOP 5</h3>
                            <div id="top-transactions" class="space-y-0 divide-y divide-slate-800"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Render: Analysis Charts (Logic) ---
        function renderAnalysisCharts() {
            const picker = document.getElementById('analysis-month-picker');
            if(!picker) return;
            const [year, month] = picker.value.split('-').map(Number);
            const monthlyData = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getFullYear() === year && (d.getMonth() + 1) === month;
            });

            const totalExp = monthlyData.filter(t => t.type === 'expense').reduce((a, b) => a + b.amount, 0);
            const totalInc = monthlyData.filter(t => t.type === 'income').reduce((a, b) => a + b.amount, 0);
            const daysInMonth = new Date(year, month, 0).getDate();
            const dailyAvg = daysInMonth > 0 ? totalExp / daysInMonth : 0;

            document.getElementById('stat-expense').textContent = formatCurrency(totalExp);
            document.getElementById('stat-income').textContent = formatCurrency(totalInc);
            document.getElementById('stat-balance').textContent = formatCurrency(totalInc - totalExp);
            document.getElementById('stat-daily').textContent = formatCurrency(dailyAvg);

            const daysMap = new Array(daysInMonth).fill(0).map((_, i) => ({ day: i + 1, expense: 0, income: 0 }));
            monthlyData.forEach(t => {
                const d = new Date(t.date).getDate();
                if(d <= daysInMonth) {
                    if(t.type === 'expense') daysMap[d-1].expense += t.amount;
                    else daysMap[d-1].income += t.amount;
                }
            });

            const catMap = {};
            monthlyData.filter(t => t.type === 'expense').forEach(t => {
                if(!catMap[t.category.id]) catMap[t.category.id] = { ...t.category, amount: 0 };
                catMap[t.category.id].amount += t.amount;
            });
            const sortedCats = Object.values(catMap).sort((a, b) => b.amount - a.amount);

            if(charts.trend) charts.trend.destroy();
            const ctxTrend = document.getElementById('chart-trend').getContext('2d');
            charts.trend = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: daysMap.map(d => `${d.day}æ—¥`),
                    datasets: [
                        { label: 'æ”¯å‡º', data: daysMap.map(d => d.expense), borderColor: '#f43f5e', backgroundColor: (context) => { const ctx = context.chart.ctx; const gradient = ctx.createLinearGradient(0, 0, 0, 300); gradient.addColorStop(0, 'rgba(244, 63, 94, 0.5)'); gradient.addColorStop(1, 'rgba(244, 63, 94, 0)'); return gradient; }, borderWidth: 3, tension: 0.4, fill: true, pointRadius: 0, pointHoverRadius: 6, pointBackgroundColor: '#f43f5e' },
                        { label: 'æ”¶å…¥', data: daysMap.map(d => d.income), borderColor: '#10b981', backgroundColor: 'transparent', borderWidth: 3, tension: 0.4, borderDash: [6, 6], pointRadius: 0, pointHoverRadius: 6, pointBackgroundColor: '#10b981' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8, color: '#94a3b8' } } }, scales: { y: { beginAtZero: true, grid: { borderDash: [4, 4], color: '#334155' }, border: { display: false }, ticks: { color: '#64748b' } }, x: { grid: { display: false }, border: { display: false }, ticks: { color: '#64748b' } } } }
            });

            if(charts.category) charts.category.destroy();
            if(sortedCats.length > 0) {
                const ctxCat = document.getElementById('chart-category').getContext('2d');
                charts.category = new Chart(ctxCat, {
                    type: 'doughnut',
                    data: {
                        labels: sortedCats.map(c => c.name),
                        datasets: [{ data: sortedCats.map(c => c.amount), backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#f43f5e'], borderWidth: 0, hoverOffset: 10 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '75%' }
                });
                
                document.getElementById('category-legend').innerHTML = sortedCats.map((c, i) => {
                    const colors = ['bg-indigo-500', 'bg-pink-500', 'bg-amber-500', 'bg-emerald-500', 'bg-blue-500', 'bg-violet-500', 'bg-rose-500'];
                    const percent = (c.amount / totalExp * 100).toFixed(1);
                    return `<div class="flex items-center justify-between text-xs mb-2"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full ${colors[i % colors.length]} shadow-[0_0_8px_rgba(99,102,241,0.5)]"></div><span class="text-slate-300">${c.name}</span></div><span class="font-bold text-slate-100 font-mono">${percent}%</span></div>`;
                }).join('');
            }

            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = sortedCats.length ? sortedCats.map((c, i) => {
                const percent = totalExp > 0 ? (c.amount / totalExp * 100).toFixed(1) : 0;
                return `
                    <div class="group">
                        <div class="flex justify-between text-sm mb-1.5">
                            <div class="flex items-center gap-3">
                                <span class="flex items-center justify-center w-5 h-5 rounded bg-slate-800 text-[10px] font-bold text-slate-500 border border-slate-700">${i + 1}</span>
                                <span class="font-bold text-slate-300">${c.icon} ${c.name}</span>
                            </div>
                            <span class="font-bold text-slate-100 font-mono">Â¥${c.amount.toFixed(2)}</span>
                        </div>
                        <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 rounded-full transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(59,130,246,0.3)]" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('') : '<div class="text-center text-slate-500 py-10">æš‚æ— æ•°æ®</div>';

            const topTx = monthlyData.filter(t => t.type === 'expense').sort((a, b) => b.amount - a.amount).slice(0, 5);
            document.getElementById('top-transactions').innerHTML = topTx.length ? topTx.map(t => `
                <div class="flex items-center justify-between py-4 group hover:bg-slate-800/50 px-2 rounded-xl transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-2xl bg-slate-800 border border-slate-700 flex items-center justify-center text-xl shadow-inner">${t.category.icon}</div>
                        <div>
                            <div class="font-bold text-slate-200 text-sm truncate max-w-[140px]" title="${t.note}">${t.note}</div>
                            <div class="text-xs text-slate-500 font-mono">${new Date(t.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="font-bold text-rose-400 font-mono">- Â¥${t.amount.toFixed(2)}</div>
                </div>
            `).join('') : '<div class="text-center text-slate-500 py-10">æš‚æ— æ•°æ®</div>';
        }

        // --- Logic: Drag & Drop / File Upload ---
        function bindDragEvents() {
            const dropZone = document.getElementById('drop-zone');
            if(!dropZone) return;
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, e => {e.preventDefault(); e.stopPropagation();}, false));
            ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-active'), false));
            ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-active'), false));
            dropZone.addEventListener('drop', e => { if(e.dataTransfer.files.length > 0) handleFileProcess(e.dataTransfer.files[0]); }, false);
        }

        function handleFileSelect(event) { if (event.target.files.length > 0) handleFileProcess(event.target.files[0]); }

        function handleFileProcess(file) {
            const source = document.querySelector('input[name="source"]:checked').value;
            // Store basic meta for now, count will be updated after process
            currentFileMeta = {
                id: Date.now().toString(),
                name: file.name,
                type: file.name.endsWith('.pdf') ? 'pdf' : 'excel',
                date: new Date().toISOString(),
                count: 0
            };
            
            const fileName = file.name.toLowerCase();
            if (fileName.endsWith('.pdf')) readPDF(file, source);
            else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) readExcel(file, source);
            else { let encoding = (source === 'alipay' || source === 'icbc') ? 'GBK' : 'UTF-8'; attemptRead(file, source, encoding, false); }
        }

        // --- Logic: Readers ---
        function readPDF(file, source) {
            const fileReader = new FileReader();
            fileReader.onload = async function() {
                try {
                    const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) fullText += (await (await pdf.getPage(i)).getTextContent()).items.map(item => item.str).join(" ") + "\n";
                    processPDFText(fullText, source);
                } catch (err) { alert('PDF è§£æå¤±è´¥'); }
            };
            fileReader.readAsArrayBuffer(file);
        }

        function processPDFText(text, source) {
            const newTrans = [];
            const cleanText = text.replace(/\s+/g, ' ');
            const chunks = cleanText.split(/(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2}:\d{2})?/);
            for (let i = 1; i < chunks.length; i += 3) {
                const date = chunks[i] + (chunks[i+1] ? ' ' + chunks[i+1] : ' 00:00:00');
                const content = chunks[i+2];
                if (!content) continue;
                const amtMatch = content.match(/(\d+\.\d{2})/);
                if (!amtMatch) continue;
                let type = 'expense';
                if (content.includes('è´·') || content.includes('è¿˜æ¬¾') || content.includes('é€€æ¬¾')) type = 'income';
                let note = 'å·¥è¡Œäº¤æ˜“';
                const abstractMatch = content.match(/(æ¶ˆè´¹|é€€æ¬¾|è¿˜æ¬¾)\s+(.*)/);
                if (abstractMatch && abstractMatch[2]) note = abstractMatch[2].substring(0, 20).trim();
                else if(content.includes('æ¶ˆè´¹')) note = 'æ¶ˆè´¹';
                newTrans.push({ id: Date.now() + Math.random(), type, amount: parseFloat(amtMatch[0]), category: matchCategory(note, type), date, note, paymentMethod: 'å·¥è¡Œä¿¡ç”¨å¡', fileId: currentFileMeta.id });
            }
            finishFileProcess(newTrans);
        }

        function readExcel(file, source) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                processCSV(XLSX.utils.sheet_to_csv(workbook.Sheets[workbook.SheetNames[0]]), source);
            };
            reader.readAsArrayBuffer(file);
        }

        function attemptRead(file, source, encoding, isRetry) {
            const reader = new FileReader();
            reader.onload = (e) => { try { processCSV(e.target.result, source); } catch (err) { if (!isRetry) attemptRead(file, source, encoding === 'GBK' ? 'UTF-8' : 'GBK', true); else alert('è§£æå¤±è´¥'); } };
            reader.readAsText(file, encoding);
        }

        function processCSV(text, source) {
            const lines = text.split('\n');
            const newTrans = [];
            let headerIndex = -1;
            for(let i=0; i<lines.length && i<50; i++) if(lines[i].includes('é‡‘é¢') && (lines[i].includes('æ—¶é—´') || lines[i].includes('æ—¥æœŸ'))) { headerIndex = i; break; }
            if (headerIndex === -1) throw new Error('è¡¨å¤´ä¸¢å¤±');
            const headerRow = lines[headerIndex].split(',').map(c => c.trim().replace(/"/g, ''));
            const getColIdx = (k) => headerRow.findIndex(h => k.some(x => h.includes(x)));
            const idxDate = getColIdx(['æ—¶é—´', 'æ—¥æœŸ']), idxAmount = getColIdx(['é‡‘é¢']), idxType = getColIdx(['æ”¶/æ”¯', 'æ”¶æ”¯', 'ç±»å‹']);
            const idxNote = getColIdx(['å•†å“è¯´æ˜', 'å•†å“', 'åç§°']) !== -1 ? getColIdx(['å•†å“è¯´æ˜', 'å•†å“', 'åç§°']) : getColIdx(['äº¤æ˜“å¯¹æ–¹', 'å¯¹æ–¹', 'å•†æˆ·']);
            const idxMethod = getColIdx(['æ”¯ä»˜æ–¹å¼', 'æ”¶/ä»˜æ¬¾æ–¹å¼', 'ä»˜æ¬¾æ–¹å¼']);

            for (let i = headerIndex + 1; i < lines.length; i++) {
                const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
                if (!cols[idxDate] || !cols[idxAmount]) continue;
                let dateStr = cols[idxDate].replace(/\//g, '-').trim();
                if (/^\d{1,2}-\d{1,2}$/.test(dateStr)) dateStr = new Date().getFullYear() + '-' + dateStr;
                const dateMatch = dateStr.match(/\d{4}-\d{1,2}-\d{1,2}(\s+\d{1,2}:\d{1,2}:\d{1,2})?/);
                if (!dateMatch) continue;
                
                let amount = parseFloat(cols[idxAmount].replace(/[Â¥,]/g, ''));
                if (isNaN(amount)) continue;
                let note = (idxNote !== -1 && cols[idxNote] && cols[idxNote] !== '/') ? cols[idxNote] : 'äº¤æ˜“';
                let type = 'expense';
                const typeStr = idxType !== -1 ? cols[idxType] : '';
                if (typeStr.includes('æ”¶å…¥') || typeStr.includes('è¿˜æ¬¾') || typeStr.includes('é€€æ¬¾') || (amount > 0 && source === 'icbc' && !note.includes('æ¶ˆè´¹'))) type = 'income';
                if (typeStr.includes('ä¸è®¡æ”¶æ”¯') && !note.includes('èµå›') && !note.includes('æ”¶ç›Š')) type = 'expense'; 
                
                let method = source === 'icbc' ? 'å·¥è¡Œä¿¡ç”¨å¡' : (idxMethod !== -1 ? cols[idxMethod].replace('/', '') : '');
                newTrans.push({ id: Date.now() + Math.random(), type, amount: Math.abs(amount), category: matchCategory(note, type), date: dateMatch[0], note, paymentMethod: method, fileId: currentFileMeta.id });
            }
            finishFileProcess(newTrans);
        }

        function finishFileProcess(newTrans) {
            if (newTrans.length === 0) return alert('æœªè§£æåˆ°æœ‰æ•ˆè®°å½•');
            currentFileMeta.count = newTrans.length;
            importDataCache = newTrans; 
            showPreview();
        }

        // --- Logic: Categories & Updates ---
        function updateCategories(type) {
            const grid = document.getElementById('category-grid');
            if(grid) {
                grid.innerHTML = CATEGORIES[type].map(c => `
                    <div onclick="selectCategory('${c.id}')" id="cat-${c.id}" class="cursor-pointer flex flex-col items-center justify-center p-4 rounded-2xl border border-slate-700 bg-slate-800 hover:bg-slate-700 transition-all ${c.id === CATEGORIES[type][0].id ? 'border-blue-500 bg-blue-500/20 text-blue-400' : 'text-slate-400'}">
                        <div class="text-3xl mb-2 filter drop-shadow-[0_0_8px_rgba(255,255,255,0.3)]">${c.icon}</div><div class="text-xs font-bold">${c.name}</div>
                    </div>
                `).join('');
                document.getElementById('selected-category-id').value = CATEGORIES[type][0].id;
            }
        }

        function selectCategory(id) {
            document.getElementById('selected-category-id').value = id;
            document.querySelectorAll('[id^="cat-"]').forEach(el => el.className = el.id === `cat-${id}` ? "cursor-pointer flex flex-col items-center justify-center p-4 rounded-2xl border border-blue-500 bg-blue-500/20 text-blue-400 transition-all shadow-[0_0_15px_rgba(59,130,246,0.3)]" : "cursor-pointer flex flex-col items-center justify-center p-4 rounded-2xl border border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-400 transition-all");
        }

        function openEditModal(id) {
            currentEditingId = id;
            const t = transactions.find(x => x.id == id); // Loose equality
            const grid = document.getElementById('edit-category-grid');
            grid.innerHTML = CATEGORIES[t.type].map(c => `
                <div onclick="quickUpdateCategory('${c.id}')" class="cursor-pointer flex flex-col items-center justify-center p-4 rounded-2xl border transition-all ${c.id === t.category.id ? 'border-blue-500 bg-blue-500/20 text-blue-400 shadow-[0_0_15px_rgba(59,130,246,0.3)]' : 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-400'}">
                    <div class="text-3xl mb-2 filter drop-shadow-md">${c.icon}</div>
                    <div class="text-xs font-bold">${c.name}</div>
                </div>
            `).join('');
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function quickUpdateCategory(catId) {
            const tIndex = transactions.findIndex(x => x.id == currentEditingId); // Loose equality
            if (tIndex !== -1) {
                transactions[tIndex].category = CATEGORIES[transactions[tIndex].type].find(c => c.id === catId);
                saveToStorage();
                showToast('ä¿®æ”¹æˆåŠŸ');
                router(currentView);
            }
            closeEditModal();
        }

        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); currentEditingId = null; }

        // --- Previews & Imports ---
        function showPreview() {
            document.getElementById('import-step-1').classList.add('hidden');
            document.getElementById('import-preview').classList.remove('hidden');
            document.getElementById('preview-count').textContent = importDataCache.length;
            document.getElementById('preview-tbody').innerHTML = importDataCache.slice(0, 50).map(t => `
                <tr class="hover:bg-slate-700/50 transition-colors"><td class="px-6 py-4 font-mono text-xs text-slate-400">${t.date}</td><td class="px-6 py-4"><span class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded-lg text-xs font-bold border border-blue-500/30">${t.category.name}</span></td><td class="px-6 py-4 text-xs max-w-[200px] truncate text-slate-300" title="${t.note}">${t.note}</td><td class="px-6 py-4 text-xs text-slate-400">${t.paymentMethod}</td><td class="px-6 py-4 text-right font-bold font-mono ${t.type === 'income' ? 'text-emerald-400' : 'text-slate-200'}">${t.type === 'income' ? '+' : '-'} ${t.amount}</td></tr>
            `).join('');
        }
        
        function resetImport() {
            importDataCache = [];
            currentFileMeta = null;
            document.getElementById('import-step-1').classList.remove('hidden');
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('file-upload').value = '';
        }

        function commitImport() {
            // Deduplication Logic
            let addedCount = 0;
            let dupCount = 0;
            
            importDataCache.forEach(newItem => {
                const newItemDate = new Date(newItem.date).getTime();
                const isDuplicate = transactions.some(existingItem => {
                    const existingItemDate = new Date(existingItem.date).getTime();
                    const timeDiff = Math.abs(newItemDate - existingItemDate);
                    return (
                        existingItem.amount === newItem.amount &&
                        existingItem.type === newItem.type &&
                        timeDiff < 60 * 1000 // Less than 1 minute difference
                    );
                });

                if (!isDuplicate) {
                    transactions.push(newItem);
                    addedCount++;
                } else {
                    dupCount++;
                }
            });

            // Add File Meta if any new transactions were added
            if (addedCount > 0) {
                currentFileMeta.count = addedCount; // Update count to reflect actually added
                importedFiles.push(currentFileMeta);
            }

            saveToStorage(); 
            
            if (dupCount > 0) showToast(`æˆåŠŸå¯¼å…¥ ${addedCount} æ¡ï¼Œè¿‡æ»¤é‡å¤ ${dupCount} æ¡`);
            else showToast(`æˆåŠŸå¯¼å…¥ ${addedCount} æ¡æ•°æ®`);
            
            router('import'); // Stay on import page to see list
        }

        // --- File Management ---
        function requestDeleteFile(fileId) {
            showConfirm('å°†åˆ é™¤è¯¥æ–‡ä»¶å¯¼å…¥çš„æ‰€æœ‰äº¤æ˜“è®°å½•ï¼Œä¸”ä¸å¯æ¢å¤ã€‚', () => deleteFile(fileId));
        }

        function deleteFile(fileId) {
            const initialCount = transactions.length;
            // Filter out transactions with matching fileId
            transactions = transactions.filter(t => String(t.fileId) !== String(fileId));
            const deletedCount = initialCount - transactions.length;
            
            // Filter out the file meta
            importedFiles = importedFiles.filter(f => String(f.id) !== String(fileId));
            
            saveToStorage();
            showToast(`å·²åˆ é™¤æ–‡ä»¶ï¼Œå…±ç§»é™¤ ${deletedCount} æ¡è®°å½•`);
            
            // Refresh the import view
            renderImport(document.getElementById('content-area'));
            lucide.createIcons();
            bindDragEvents();
        }

        function requestDeleteTransaction(id) {
            showConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', () => deleteTransaction(id));
        }
        
        function requestClearAllData() {
            showConfirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰è´¦å•è®°å½•å’Œæ–‡ä»¶ä¿¡æ¯ï¼Œä¸”æ— æ³•æ¢å¤ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ', () => clearAllData());
        }
        
        function clearAllData() {
            transactions = [];
            importedFiles = [];
            localStorage.removeItem('myBookkeepingData');
            localStorage.removeItem('myBookkeepingFiles');
            
            showToast('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
            
            // Reset file meta if any
            currentFileMeta = null;
            
            // Refresh view
            if(currentView === 'dashboard') renderDashboard(document.getElementById('content-area'));
            else if(currentView === 'import') renderImport(document.getElementById('content-area'));
            else if(currentView === 'analysis') { renderAnalysis(document.getElementById('content-area')); renderAnalysisCharts(); }
            
            // Re-init icons
            lucide.createIcons();
        }

        function deleteTransaction(id) {
            // Loose equality to handle string vs number ID mismatch
            transactions = transactions.filter(t => t.id != id); 
            saveToStorage(); 
            if(currentView === 'dashboard') renderDashboard(document.getElementById('content-area')); 
            showToast('å·²åˆ é™¤è®°å½•'); 
            lucide.createIcons(); 
        }

        // --- Confirm Modal Logic ---
        let confirmCallback = null;

        function showConfirm(msg, callback) {
            document.getElementById('confirm-msg').textContent = msg;
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        }

        document.getElementById('confirm-btn-action').onclick = function() {
            if(confirmCallback) confirmCallback();
            closeConfirmModal();
        }

        // --- Init ---
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        router('dashboard');
    </script>
</body>
</html>